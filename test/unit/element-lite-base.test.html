<!doctype html>
  <html>
  <head>
    <meta charset="utf-8">
    <script src="../../../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../../wct-browser-legacy/browser.js"></script>
  </head>
  <body>

    <test-element id="test" prop1="a" prop2="b"></test-element>

    <script type="module">

      import { ElementLiteBase } from '../../element-lite-base.js';

      /**
       * @extends {ElementLiteBase}
      */
      class TestElement extends ElementLiteBase(window.HTMLElement) {
        static get is () { return 'test-element'; }

        static get properties () {
          return {
            prop1: {
              type: String
            },

            prop2: {
              type: String
            },

            prop3: {
              type: String,
              value: 'c'
            },

            prop4: {
              type: String,
              observer: '_prop4Changed'
            },


          };
        }

        constructor() {
          super();
          sinon.spy(this, '_propertiesChanged');
          this._prop4Changed = sinon.spy();
        }
      }

      window.customElements.define(TestElement.is, TestElement);
      window.TestElement = TestElement;
    </script>

    <script type="module">
      suite('ElementLiteBase Mixin', () => {
        test('should have not be a HTMLUnknownElement constructor', () => {
          const el = document.querySelector('#test');
          expect(el.constructor.is).to.equal('test-element');
        });

        /**
         * Checking if attributes is reflected to properties
         * https://github.com/Polymer/polymer/blob/__auto_generated_3.0_preview/test/unit/properties-changed.html
         */

        test('attributes reflected to properties via upgrade', () => {
          const el = document.querySelector('#test');
          expect(el.prop1).to.equal('a');
          expect(el.prop2).to.equal('b');
        });

        /**
         * Checking if the _propertiesChanged method is called
         * https://github.com/Polymer/polymer/blob/__auto_generated_3.0_preview/test/unit/properties-changed.html
         */

        test('setting properties results in _propertiesChanged', done => {
          const el = document.createElement('test-element');
          document.body.appendChild(el);
          el.prop1 = 'a';
          el.prop2 = 'b';
          assert.equal(el._propertiesChanged.callCount, 0, '_propertiesChanged is not async');
          setTimeout(() => {
            expect(el._propertiesChanged.calledOnce).to.be.true;

            // currentProps
            expect(el._propertiesChanged.getCall(0).args[0].prop1).to.equal('a');
            expect(el._propertiesChanged.getCall(0).args[0].prop2).to.equal('b');

            // changedProps
            expect(el._propertiesChanged.getCall(0).args[1].prop1).to.equal('a');
            expect(el._propertiesChanged.getCall(0).args[1].prop2).to.equal('b');

            // oldProps
            expect(el._propertiesChanged.getCall(0).args[2].prop1).to.equal(undefined);
            expect(el._propertiesChanged.getCall(0).args[2].prop2).to.equal(undefined);

            // reflect on property
            expect(el.prop1).to.equal('a');
            expect(el.prop2).to.equal('b');

            el.prop1 = 'aa';
            setTimeout(() => {
              expect(el._propertiesChanged.calledTwice).to.be.true;

              // currentProps
              expect(el._propertiesChanged.getCall(1).args[0].prop1).to.equal('aa');
              expect(el._propertiesChanged.getCall(1).args[0].prop2).to.equal('b');

              // changedProps
              expect(el._propertiesChanged.getCall(1).args[1].prop1).to.equal('aa');
              expect('prop2' in el._propertiesChanged.getCall(1).args[1]).to.be.false;

              // oldProps
              expect(el._propertiesChanged.getCall(1).args[2].prop1).to.equal('a');
              expect('prop2' in el._propertiesChanged.getCall(1).args[2]).to.be.false;

              document.body.removeChild(el);
              done();
            });
          });
        });

        test('setting attributes results in _propertiesChanged', done => {
          const el = document.createElement('test-element');
          document.body.appendChild(el);
          el.setAttribute('prop1', 'a');
          el.setAttribute('prop2', 'b');
          setTimeout(()  => {
            expect(el._propertiesChanged.calledOnce).to.be.true;

            // currentProps
            expect(el._propertiesChanged.getCall(0).args[0].prop1).to.equal('a');
            expect(el._propertiesChanged.getCall(0).args[0].prop2).to.equal('b');

            // changedProps
            expect(el._propertiesChanged.getCall(0).args[1].prop1).to.equal('a');
            expect(el._propertiesChanged.getCall(0).args[1].prop2).to.equal('b');

            // oldProps
            expect(el._propertiesChanged.getCall(0).args[2].prop1).to.equal(undefined);
            expect(el._propertiesChanged.getCall(0).args[2].prop2).to.equal(undefined);

            // reflect on property
            expect(el.prop1).to.equal('a');
            expect(el.prop2).to.equal('b');

            el.setAttribute('prop1', 'aa');
            setTimeout(() => {
              expect(el._propertiesChanged.calledTwice).to.be.true;

              // currentProps
              expect(el._propertiesChanged.getCall(1).args[0].prop1).to.equal('aa');
              expect(el._propertiesChanged.getCall(1).args[0].prop2).to.equal('b');

              // changedProps
              expect(el._propertiesChanged.getCall(1).args[1].prop1).to.equal('aa');
              expect('prop2' in el._propertiesChanged.getCall(1).args[1]).to.be.false;

              // oldProps
              expect(el._propertiesChanged.getCall(1).args[2].prop1).to.equal('a');
              expect('prop2' in el._propertiesChanged.getCall(1).args[2]).to.be.false;
              document.body.removeChild(el);
              done();
            });
          });
        });

        /**
         * Checking if default value is called
         */
        test('defualt value is set using the attribute `value` in props', () => {
          const el = document.createElement('test-element');
          document.body.appendChild(el);
          expect(el.prop3).to.equal('c');
          document.body.removeChild(el);
        });

        /**
         * Checking if observer method is called if the value of the prop has changed
         */
        test('observer method is called if the value of the prop has changed and should also get old data', done => {
          const el = document.createElement('test-element');
          document.body.appendChild(el);
          el.prop4 = 'd';
          setTimeout(() => {
            expect(el._prop4Changed.calledOnce).to.be.true;
            expect(el._prop4Changed.getCall(0).args[0]).to.equal('d');
            expect(el._prop4Changed.getCall(0).args[1]).to.equal(undefined);
            el.prop4 = 'dd';
            setTimeout(() => {
              expect(el._prop4Changed.calledTwice).to.be.true;
              expect(el._prop4Changed.getCall(1).args[0]).to.equal('dd');
              expect(el._prop4Changed.getCall(1).args[1]).to.equal('d');
              document.body.removeChild(el);
              done();
            })
          });
        });

      });
    </script>
  </body>
</html>