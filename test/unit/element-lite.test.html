<!doctype html>
  <html>
  <head>
    <meta charset="utf-8">
    <script src="../../../../@webcomponents/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../../../wct-browser-legacy/browser.js"></script>
    <script src="../../../../@polymer/iron-test-helpers/mock-interactions.js"></script>
  </head>
  <body>

    <test-element-three id="test"></test-element-three>

    <script type="module">
      import { ElementLite, html } from '../../element-lite.js';

      /**
       * @extends {ElementLite}
      */
      class TestElement extends ElementLite(window.HTMLElement) {
        static get is () { return 'test-element-three'; }

        static get properties () {
          return {
            prop1: {
              type: String
            },

            prop2: {
              type: Object,
              value: {}
            }
          }
        }

        constructor() {
          super();
          this._boundedButtonClicked = this._buttonClicked.bind(this);
          sinon.spy(this, '_boundedButtonClicked');
        }

        render () {
          return html`
            <style>
              #button {
                width: 500px;
              }
            </style>
            <span id="span">${this.prop1}</span>
            <span id="span-two">${this.prop2.attr1}</span>
            <button id="button" type="button" on-click=${this._boundedButtonClicked}>Test</button>
          `;
        }

        _buttonClicked () {
          this.prop1 = 'changed';
        }
      }

      window.customElements.define(TestElement.is, TestElement);
      window.TestElement = TestElement;
    </script>

    <script type="module">
      suite('ElementLite Mixin', () => {
        test('should have not be a HTMLUnknownElement constructor', () => {
          const el = document.querySelector('#test');
          expect(el.constructor.is).to.equal('test-element-three');
        });

        test('shadow root elements should exist', () => {
          const el = document.querySelector('#test');
          const span = el.shadowRoot.querySelector('#span');
          const span2 = el.shadowRoot.querySelector('#span-two');
          const button = el.shadowRoot.querySelector('#button');
          expect(span).to.exist;
          expect(span2).to.exist;
          expect(button).to.exist;
        });

        test('shadowRoot changes when props changed', done => {
          const el = document.createElement('test-element-three');
          document.body.append(el);
          el.prop1 = 'a';
          el.set('prop2.attr1', 'b');
          setTimeout(() => {
            expect(el.shadowRoot.querySelector('#span').textContent.trim()).to.equal('a')
            expect(el.shadowRoot.querySelector('#span-two').textContent.trim()).to.equal('b')
            document.body.removeChild(el);
            done();
          });
        });

        test('button can be clicked', done => {
          const el = document.createElement('test-element-three');
          document.body.append(el);
          const button = el.shadowRoot.querySelector('#button');
          expect(button).to.exist;
          MockInteractions.tap(button);
          setTimeout(() => {
            expect(el._boundedButtonClicked.calledOnce).to.be.true;
            expect(el.prop1).to.equal('changed');
            expect(el.shadowRoot.querySelector('#span').textContent.trim()).to.equal('changed')
            document.body.removeChild(el);
            done();
          });
        });

        test('button style is changed', () => {
          const el = document.createElement('test-element-three');
          document.body.append(el);
          const button = el.shadowRoot.querySelector('#button');
          expect(button).to.exist;
          expect(button.getBoundingClientRect().width).to.equal(500);
        });
      });
    </script>
  </body>
</html>